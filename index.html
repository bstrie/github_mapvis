<!DOCTYPE html>
<html>
<head>
<meta charset="utf-8">
<title>Map</title>

<script type="text/javascript" src="d3/d3.js"></script>
<script type="text/javascript" src="d3/d3.geo.js"></script>
<script src="jquery.min.js"></script>

<style type="text/css">
body {
  margin: 0;
  background-color: #e1f2ff;
}

svg {
  width: 100%;
  height: 480px;
  border: solid 0px #ccc;
  background: #e1f2ff;
}

#container {
  width: 1000px;
  margin-left: auto;
  margin-right: auto;
}

#states path {
  fill: #a6e17e;
  stroke: #fff;
}

#states circle {
  fill: red;
}
</style>
</head>
<body>

<div id="container"></div>

<script type="text/javascript">

MIN_RADIUS = 2.5;
THE_MOON = {lat: -50,
            lon: 0};

function shrinken(val) {
  r = Math.pow(val, 1/4.1);
  if (r < MIN_RADIUS) { return MIN_RADIUS; }
  else { return r; }
}

function moonify(coords) {
  if (coords.lat === 'MOON') {
    // THE GREAT GYRE
    return [THE_MOON.lon, THE_MOON.lat];
  }
  else {
    return [coords.lon, coords.lat];
  }
}

var mercator = d3.geo.mercator().translate([500, 190]).scale(1000);

var path = d3.geo.path().projection(mercator);

var map = d3.select("#container")
            .append("svg:svg")
            .append("svg:g")
            .attr("id", "states")
            .attr("transform", "translate(0, 100)");

d3.json("d3/world-countries.json", function(collection) {
  d3.select("#states")
    .selectAll("path")
    .data(collection.features)
    .enter().append("svg:path")
    .attr("d", path);

  d3.json("data/betterfeb1data.json", function(json) {
    map.selectAll("dots")
       .data(json, function(d) { return d.name })
       .enter()
       .append("svg:g")
       .attr("transform", function(d) {
         var coord = moonify(d);
         return "translate(" + mercator(coord).join(",") + ")";
       })
       .append("svg:circle")
       .attr("stroke-width", "none")
       .attr("fill", "red")
       .attr("r", 0)
       .attr("class", "dots")
       .attr("fill-opacity", 0)
       .transition()
       .duration(500)
       .attr("r", function(d) { return shrinken(d.impact) })
       .attr("fill-opacity", 0.225);
  });
});

</script>

</body>
</html>
