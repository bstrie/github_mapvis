<!DOCTYPE html>
<html>
<head>
<meta charset="utf-8">
<title>Rust Compiler Contributor Map</title>

<script type="text/javascript" src="d3/d3.js"></script>
<script type="text/javascript" src="d3/d3.geo.js"></script>
<script src="jquery.min.js"></script>

<style type="text/css">
body {
  margin: 0;
  background-color: #e1f2ff;
}

svg {
  width: 100%;
  height: 480px;
  border: solid 0px #ccc;
  background: #e1f2ff;
}

#container {
  width: 1000px;
  margin-left: auto;
  margin-right: auto;
}

#states path {
  fill: #a6e17e;
  stroke: #fff;
}

#states circle {
  fill: red;
}

#text {
  font-family: sans-serif;
}
</style>
</head>
<body>

<div id="container">
  <div id="map"></div>
  <div id="text">
    <p>This chart depicts the impact and geographic location of each contributor to the Rust compiler.</p>
    <p>Location data is taken from each user's Github profile for users who have elected to disclose that information. Precise coordinates are found by running location strings through the Google Maps API; for example, with a location of "Canada" you will be depicted as inhabiting a shack in remote Saskatchewan. Users without location data can be found floating near the Antarctic.</p>
    <p>I have cut the top of the map off at the Arctic circle. If you live in Svalbard, I'm truly sorry&mdash;blame <a href="http://en.wikipedia.org/wiki/Gerardus_Mercator">this guy</a>. Same goes for Antarctica, but if you're sincerely contributing Rust code from Amundsenâ€“Scott then that's pretty rad.</p>
    <p>Impact is measured as the sum of lines added and lines deleted for all commits to the master branch. Github only makes this data available for the top 100 contributors to any given repository; for the remaining users, their location is denoted by a dot of the minimum size.
  </div>
</div>

<script type="text/javascript">

MIN_RADIUS = 2.5;
THE_MOON = {lat: -50,
            lon: 0};

function shrinken(val) {
  r = Math.pow(val, 1/4.1);
  if (r < MIN_RADIUS) { return MIN_RADIUS; }
  else { return r; }
}

function moonify(coords) {
  if (coords.lat === 'MOON') {
    // THE GREAT GYRE
    return [THE_MOON.lon, THE_MOON.lat];
  }
  else {
    return [coords.lon, coords.lat];
  }
}

var mercator = d3.geo.mercator().translate([500, 190]).scale(1000);

var path = d3.geo.path().projection(mercator);

var map = d3.select("#map")
            .append("svg:svg")
            .append("svg:g")
            .attr("id", "states")
            .attr("transform", "translate(0, 100)");

d3.json("d3/world-countries.json", function(collection) {
  d3.select("#states")
    .selectAll("path")
    .data(collection.features)
    .enter().append("svg:path")
    .attr("d", path);

  d3.json("data/newest.json", function(json) {
    map.selectAll("dots")
       .data(json, function(d) { return d.name })
       .enter()
       .append("svg:g")
       .attr("transform", function(d) {
         var coord = moonify(d);
         return "translate(" + mercator(coord).join(",") + ")";
       })
       .append("svg:circle")
       .attr("stroke-width", "none")
       .attr("fill", "red")
       .attr("r", 0)
       .attr("class", "dots")
       .attr("fill-opacity", 0)
       .transition()
       .duration(500)
       .attr("r", function(d) { return shrinken(d.impact) })
       .attr("fill-opacity", 0.175);
  });
});

</script>

</body>
</html>
